# 宿舍经济营销系统需求文档

## 项目概述
- 使用 Node.js + TypeScript 开发控制台应用
- 部署在树莓派上运行
- 分为经营模式和管理模式两个独立程序

## 核心定义

### 本次进店定义
- **是否在店定义**：目标顾客最晚的订单在3分钟内创建
- **本次进店所有订单定义**：每个订单前后创建时间间隔小于3分钟的一组连续的订单，且组内最晚的订单在3分钟前创建
- **应用场景**：
  - 满消费送商品活动的消费计算
  - 顾客消费记录的分组展示
  - 累计实付现金的统计

## 一、经营模式（独立程序）

### 1. 顾客管理
- 运行前提供已有顾客简称，后续操作基于该顾客进行
- 创建新顾客：输入"."或"。"开头的命令，提供真实姓名、唯一简称，任何信息不能为空（为空则退出）
- 找不到新用户时，先询问"用户不存在，是否创建新用户？(y/n)"，确认后才进入创建流程

### 2. 调试模式
暂无

### 3. 现金购物
- 展示商品名、价格、促销活动（会员专享）
- 隐藏零库存商品，单独列出已售罄商品
- 顾客输入商品序号、数量，单次结算（无购物车，每次限一个品种）
- 结算流程：
  - 自动应用最优优惠
  - 填写备注
  - 展示顾客资产明细、应付金额
- **一键赊账功能**：
  - 结算确认后，提供一键赊账选项
  - 自动记录订单信息到赊账记录
  - 仅适用于现金购物（特殊用户实付为0时不显示）
- 结算后输出订单信息和校验码，用于手写纸质小票
- 如未使用一键赊账，提示在管理模式手动操作

### 4. 积分商城（会员专享）
- 展示商品名、价格
- 隐藏零库存商品，单独列出已售罄商品
- 顾客输入商品序号、数量
- 结算流程：
  - 填写备注
  - 展示资产明细、应付积分

### 5. 累计实付现金展示
- 在退出经营模式前，自动展示当前会话累计实付现金（不含积分）
- 计算逻辑：
  - 统计当前会话期间所有现金订单的实付金额
  - 扣除相应退款订单的退款金额
  - 显示订单详情和退款扣除明细
  - 展示最终累计实付现金总额

### 6. 积分抽奖（会员专享）
- 功能已禁用

## 二、管理模式（独立程序）

### 1. 商品看板
- 基于 JSON 文件展示商品信息
- 展示内容：
  - 库存、售价、成本
  - 周期内/累计：顾客实付现金、商家利润、商品成本
  - 促销活动
  - 周期内收入
  - 周期内销量：统计每个商品周期内的销售数量
  - 近2小时销量：统计每个商品最近2小时的销售数量
  - [忽略] [TODO] 商品看板 送积分：展示每个商品通过促销活动送出的总积分


### 2. 活动看板
- 基于 JSON 文件展示活动信息
- 展示内容：
  - 剩余活动预算
  - 积分商城商品
  - 促销活动模板

### 3. 顾客看板
- 展示顾客详细信息

### 4. 资产管理
- 充/扣活动预算、顾客积分、顾客赊账
- **赊账管理功能**：
  - 支持手动赊账调整
  - 允许添加自定义备注
  - 详细记录赊账前后金额
  - 提供友好的用户交互界面
- 所有操作需填写原因

### 5. 库存管理
- 选择修改现有商品/上架新商品
- 上架新商品（现金购物/积分商城），需填写并检验有效性：
  - 自定义字符串 ID（唯一）
  - 名字
  - 价格（现金+积分；只有现金/积分数值为0时不在现金购物/积分兑换展示）
  - 成本
  - 初始库存
  - 促销活动模板（显示所有可用优惠策略供选择）
- 修改现有商品：
  - 调整库存：手动增减库存（需填写说明，不创建订单，计入其他日志）
  - 修改优惠策略：显示所有可用优惠策略，支持多选（逗号分隔）或清空
  - 修改价格：支持单独修改现金售价或积分售价

### 6. 退款功能
- 输入订单号
- 输入退款商品数量（必须输入正整数且不超过订单数量，检查异常数值，用于部分退款）
- 输入退款原因
- 展示退款详情（包括金额、积分、影响等）
- 输入大写 Y 确认退款
- **赊账调整功能**：
  - 退款成功后，若用户有欠款，提供赊账调整选项
  - 支持自动抵扣（退款金额直接抵扣欠款）
  - 支持手动输入调整金额
  - 提供跳过调整的选项

### 7. 导出功能
- 在控制台输出欠债名单，包含最后消费时间

### 8. 活动预算管理
- 手动加/减预算功能（计入其他日志）

### 9. 校验码反查功能
- 输入6位校验码，通过校验码查找对应的订单
- 从最晚的订单向前遍历，逐个计算校验码并比对
- 显示匹配订单的详细信息：
  - 订单号、时间、用户、商品信息
  - 实付现金、实付积分、奖励积分
  - 订单类型（现金购买/积分兑换）
  - 备注信息（如有）
  - 退款记录（如有）
  - 校验码计算参数
- 显示查找进度（每检查10个订单显示一次）
- 支持6位校验码（原为4位）

### 10. 查询顾客消费记录
- 输入顾客简称，查询该顾客过去21天的消费记录
- 显示用户基本信息：简称、真实姓名、会员状态、当前积分、当前欠款
- 按"进店"为单位分组显示消费记录：
  - 基于"本次进店"定义：每个订单前后创建时间间隔小于3分钟的一组连续的订单
  - 显示每次进店的开始时间、结束时间、订单数量
  - 显示每次进店的消费总额（现金+积分）
  - 按时间正序排列，显示每次进店的详细订单记录
- 显示退款记录：退款现金、退款积分、扣除奖励积分
- 显示消费统计：
  - 实付现金、实付积分、获得奖励积分、净消费
  - 21天内消费总额（仅现金消费，扣除退款）
- 显示会员状态相关信息：
  - 会员门槛（21天内消费）
  - 距离会员门槛的金额

## 三、数据结构

### 1. 订单
- 订单 ID：由日期、商品 ID、随机数构成
- 时间、顾客、商品、现金金额、积分金额、返利积分、操作原因等

### 2. 退款订单
- 退款订单 ID、原订单 ID、日期、实际退款信息（实际退还现金金额、积分金额、实际扣除返利积分）、操作原因等

### 3. 货架
- 展示已上架商品（隐藏下架商品）
- 包含所有已上架商品的自定义字符串 ID

### 4. 商品
- 可通过现金购买、积分兑换获得
- 属性：自定义 ID、名字、价格、成本、促销活动、库存（当前/初始）等

### 5. 顾客
- 属性：会员等级（基于订单历史实时计算）、欠费金额、积分（直接读取JSON中的points字段）、总消费额（现算不存）、周期内消费额（现算不存）等
- 会员等级：
  - 特殊用户（SPECIAL）：在 member_config.json 中手动指定的特殊用户
  - 正式会员（OFFICIAL）：前 x 天内消费满 y 元自动获得
  - 见习会员（TRAINEE）：默认等级，不满足正式会员条件时

### 6. 促销活动模板
- 类型：买 x 包送 y 积分、买满 x 元送 y 积分

### 7. 订单号规则
- 格式：prefix+年+月+日+时+分+秒+毫秒+2位随机数

### 8. 校验码算法
- sha1("salt"+String(订单号、实付金额/积分、返利积分)).substring(0, 6).toUpperCase()

### 9. 会员失效提醒逻辑
- 只有当【当前总消费 >= 13元（门槛）】且【当前总消费 - 明天失效订单金额 < 13元】时，才触发警告提醒
- 精确计算"明天即将滚出窗口"的那部分订单金额（即 timestamp 处于 windowStartDate 到 windowStartDate + 1天 之间的订单）

### 10. 退款与库存逻辑
- 退款时，如果订单实付为 0（如 SPECIAL 级别用户），根据退款金额与单价的比例计算库存恢复
- 如果订单是积分支付，按积分退款比例计算库存恢复
- 确保比例在合理范围内（0到1之间）
- 积分计算逻辑健壮，处理 SPECIAL 用户（倍率为 0）时不会出现异常

### 11. 系统运行控制
- 实现进程锁机制，确保同一时间只能运行一个程序实例
- 程序启动时检查PID文件，防止重复运行
- 程序退出时自动清理PID文件

## 四、营销活动规则

### 1. 积分体系
- 1 积分 = 1 元（等价现金，不可提现）
- 积分不过期，积分上限 5（配置项 MAX_POINTS）

### 2. 活动预算
- 增加途径：
  - 管理模式手动增加
  - ~~积分商城的商家利润~~（已移除，预算仅由手动调整构成）
- 扣除途径：
  - 管理模式手动扣除
- 预算定义：活动预算仅由 otherLogs 中类型为 budget_adjust 的记录构成
- 扣除逻辑预留：活动预算仅用于未来"积分抽奖"功能的中奖成本扣除，目前不允许任何订单自动扣除它

### 3. 促销活动
- 方便面买赠：
  - 买 x 袋送 y 积分，买更多送更多
  - 赠送积分属于让利，不扣活动预算
  - 仅现金购物参与，积分兑换不参与
  - 移除优惠限制（无每周限购）
  - 积分上限逻辑：
    - 如果用户当前积分已达到或超过 MAX_POINTS，仍然允许其积分增加（作为记录）
    - 拦截逻辑：在现金购物下单前增加检查，如果该商品包含赠送积分，且用户当前积分已 ≥ MAX_POINTS，则拒绝下单并提示"积分已达上限，请先消耗积分后再购买此类商品"

### 4. 会员规则
- 会员分为三个等级：特殊用户、正式会员、见习会员
  - 特殊用户（SPECIAL）：
    - 在 member_config.json 中手动指定的特殊用户（如店长、死党）
    - 可获得积分，实际获得积分=原积分*0%（不给积分）
    - 无法参与买就送积分，无法参与积分兑换、积分抽奖
    - 正常计入销售额、利润、销量等营销数据指标
    - 下单时实付金额强制设为0元，产生负利润订单
  - 正式会员（OFFICIAL）：
    - 基于滑动窗口消费额的实时会员制，前 x 天内消费满 y 元自动获得正式会员资格
    - 可获得积分，实际获得积分=原积分*100%
    - 可参与积分兑换、积分抽奖
  - 见习会员（TRAINEE）：
    - 用户注册后/不满足正式会员时，永久拥有见习会员权限
    - 可获得积分，实际获得积分=原积分*50%
    - 可以参与积分兑换、积分抽奖（与正式会员权益相同，仅积分倍率不同）
- 正式会员有效期计算方式：
  - 新规则：基于滑动窗口消费额的实时会员制，配置参数：
    - LOOKBACK_DAYS: 滑动窗口天数（默认21天）
    - TRIGGER_AMOUNT: 触发正式会员的消费额（默认13元）
  - 手动指定：通过 member_config.json 文件手动设置正式会员有效期（保留兼容性）
- 会员状态变化提醒：
  - 当用户消费接近会员门槛时，提示用户鼓励消费升级
  - 当正式会员有大额订单即将"滚出"滑动窗口时，提醒用户补充消费以维持会员状态
- 积分倍率配置：
  - 在 member_config.json 中配置不同会员等级的积分倍率
  - 默认配置：特殊用户0%、见习会员50%、正式会员100%

### 5. 退款风控
- 退款时计算 resultingPoints = 当前积分 + 退回积分 - 扣除赠分
- 如果 resultingPoints < 0，必须进行二次确认，询问："⚠️ 警告：退款后积分为负（${resultingPoints}），是否继续？(y/n)"
- 若输入不是 'y' 则中断操作

### 6. 财务统计
- 汇率统一度量：严格遵守 1 人民币 = 1 积分
- 利润计算方式：
  - 现金利润 = 现金购物时实付金额 - 成本 - 赠送积分
  - 积分利润 = 积分兑换时实付积分 - 成本
  - 总利润 = 现金利润 + 积分利润
- 积分折现不再乘以 0.01，直接 1:1 统计

### 7. 滑动窗口计算
- 确保 processRefund 成功后，退款记录能正确影响 getUserTotalSpendInWindow 的计算
- 会员判定实时更新，基于订单历史扣除相应退款金额

### 8. 满消费送商品活动
- 预设小零食为赠品（商品ID：snack_001）
- 见习会员每消费1.75元送一包小零食
- 正式会员每消费1.25元送一包小零食
- 在退出经营模式前根据**本次进店**消费总额计算赠送数量，不创建订单
- 基于"本次进店"定义：每个订单前后创建时间间隔小于3分钟的一组连续的订单，且组内最晚的订单在3分钟前创建
- 检查用户是否在店（最晚订单在3分钟内），不在店时显示提示信息
- 显示还需消费多少才能获得赠品
- 通过配置项 GIFT_PROMOTION 控制活动开关、赠品ID和赠送策略

### 9. 进程锁功能
- 确保同一时间只能运行一个程序进程
- 当程序已运行时，提示用户执行kill命令终止现有进程
- 使用PID文件跟踪运行中的进程

### 8. 配置项
- 在 Config 接口和 config.json 中增加 MAX_POINTS 配置项（默认 5）
- 在 Config 接口和 config.json 中增加 GIFT_PROMOTION 配置项，用于满消费送商品活动

### 9. 抽奖规则
- 敬请期待，我目前不想开发抽奖功能

### 特殊用户
- 特殊用户已整合到会员系统中，作为会员等级之一（SPECIAL）
- 在 member_config.json 中配置特殊用户列表
- 照常扣除库存
- 正常计入销售额、利润、销量等营销数据指标
- 下单时实付金额强制设为0元，产生负利润订单
- 特殊用户无法参与买就送积分，无法参与积分兑换
- 经营统计中单独展示特殊用户的成本统计：
  - 显示周期内特殊用户成本
  - 显示累计特殊用户成本
  - 显示特殊用户订单数量

## 五、特殊规则

### 1. 库存变动
- 通过现金购物、积分兑换、手动操作（不创建订单，直接扣减初始库存，计入其他日志）变动库存

### 2. 退款规则
- 7 天内可退款/退积分
- 参与买返的商品退款时扣除赠送积分
  - 积分不足可扣为负数（需二次确认）
- 买就送订单拆分退款公式：
  - 需扣除积分 = (申请退款包数 ÷ 购买总包数) × 获得总积分
  - 应退款金额 = (申请退款包数 ÷ 购买总包数) × 实付总金额 - 不足以扣除的积分（如有）
- 抽奖功能已禁用

### 3. 赊账规则
- 赊账额允许为负数（商家欠顾客钱）
- **一键赊账功能**：
  - 现金购物结算时，提供一键赊账选项
  - 自动记录订单信息（订单号、商品、数量、金额）
  - 仅适用于现金购物，不适用于积分兑换
- **退款赊账调整**：
  - 退款成功后，若用户有欠款，提供一键赊账调整选项
  - 支持自动抵扣（退款金额直接抵扣欠款）
  - 支持手动输入调整金额
  - 提供跳过调整的选项
- **手动赊账管理**：
  - 管理模式支持手动赊账调整
  - 允许添加自定义备注
  - 详细记录赊账前后金额

### 4. 数据处理
- 营销活动允许商家亏钱
- 现金/积分购买/中奖均属于售出商品
- 现金利润直接入账，积分利润放入活动预算

### 5. 性能与存储
- 程序规模小（每周约10单），性能非关键
- 除订单历史、会员配置和不可变数据外，所有数据基于订单历史现场计算
- 使用 JSON 文件存储数据
- 会员配置存储在 member_config.json 中，包含：
  - 特殊用户列表
  - 积分倍率配置
  - 正式会员有效期手动设置

## 八、会员规则重构说明

### 1. 重构目标
- 实现基于"滑动窗口消费额"的实时会员制
- 统一配置入口为config.json中的MEMBER.NEW_RULE
- 删除原有的会员过期和降级警告机制
- 优化会员状态变化提醒，提供更精准的经营提示

### 2. 主要变更
- 删除calculateMemberExpiryDate方法，不再计算会员过期时间
- 新增getUserTotalSpendInWindow方法，计算滑动窗口内总消费额
- 重构isUserMember方法，直接基于滑动窗口消费额判定会员状态
- 重构checkAndNotifyMembershipChange方法，整合滑动窗口消费逻辑
- 重构checkMembershipStatus方法，提供更精准的经营提示
- 删除MemberConfig接口中的membershipWarning配置

### 3. 配置参数
- MEMBER.NEW_RULE.LOOKBACK_DAYS: 滑动窗口天数（默认21天）
- MEMBER.NEW_RULE.TRIGGER_AMOUNT: 触发正式会员的消费额（默认13元）

### 4. 会员判定逻辑
1. 特殊用户：直接判定为特殊会员（SPECIAL）
2. 手动指定会员：检查member_config.json中的members配置
3. 滑动窗口消费额：计算前LOOKBACK_DAYS天内的现金订单总消费（扣除退款）
4. 若消费额≥TRIGGER_AMOUNT，则为正式会员（OFFICIAL），否则为见习会员（TRAINEE）

### 5. 会员状态变化提醒
- 当见习会员消费额接近会员门槛（差值≤5元）时，提示用户鼓励消费升级
- 当正式会员有大额订单即将"滚出"滑动窗口时，提醒用户补充消费以维持会员状态
- 在用户购物界面显示当前会员状态和滑动窗口消费额

### 6. 兼容性处理
- 保留member_config.json中的手动会员配置，确保向后兼容
- 保留特殊用户和积分倍率配置，不影响现有功能

## 九、数据记录规则

### 1. 其他日志系统 (otherLogs)
以下操作计入其他日志 (data/store_data.json 的 otherLogs)：
- 手动增减预算 (budget_adjust)
- 手动操作赊账 (debt_adjust)
- 手动操作积分 (points_adjust)
- 手动增减库存 (inventory_adjust)

### 2. 日志类型说明
- budget_adjust: 活动预算调整，用于计算活动预算
- debt_adjust: 赊账调整，记录用户欠款变动
  - **一键赊账**：自动记录订单信息（订单号、商品、数量、金额）
  - **手动赊账**：记录赊账前后金额，支持自定义备注
  - **退款相关调整**：记录退款订单信息
- points_adjust: 积分调整，记录用户积分变动
- inventory_adjust: 库存调整，记录商品初始库存变动

### 3. 操作日志原则
- 对不依赖历史订单计算的数据的更改需记录
- 所有手动操作均记录到 otherLogs 统一管理
- 为单个顾客编辑积分不计入活动预算

## 七、示例数据

### 1. 现金购物商品
- 方便面：进价1.3元，售价2元，买2包送0.5积分
- 小包零食：进价0元，售价0.2元
- 大包零食：进价0.4元，售价1元

### 2. 积分商城商品
- 方便面：进价1.3积分，售价1.75积分
- 小包零食：进价0积分，售价0.2积分
- 大包零食：进价0.4积分，售价1积分

### 3. 奖池示例

#### 奖池1（每抽0.28积分，新人首抽0.1积分）
- 小包零食：65%
- 0.33积分：15%
- 大包零食：10%
- 0.5积分：7%
- 1积分：3%
- 新人首抽移除小包零食，概率分给0.33积分

#### 奖池2（每抽1.18积分）
- 大包零食：90%
- 2.88积分：10%